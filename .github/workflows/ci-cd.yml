name: CI/CD Pipeline

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  # ============================================
  # Job 1: Build and Test (runs on all PRs and pushes)
  # ============================================
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Lint code
        run: yarn lint

      - name: Build project
        run: yarn build

      - name: Run tests
        run: yarn test

  # ============================================
  # Job 2: PR Handler (auto-merge owner PRs, request approval for others)
  # ============================================
  pr-handler:
    needs: build
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write
    
    steps:
      - name: Check PR template is filled
        id: check_template
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';
            
            // Basic validation: check if PR has content and not just template
            const hasContent = body.length > 100 && !body.includes('<!-- Briefly explain');
            
            if (!hasContent) {
              console.log('‚ö†Ô∏è PR template appears to be incomplete');
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: '‚ö†Ô∏è **PR Template Incomplete**: Please fill out the PR template with details about your changes.'
              });
              
              core.setOutput('template_filled', 'false');
            } else {
              console.log('‚úÖ PR template appears to be filled');
              core.setOutput('template_filled', 'true');
            }

      - name: Check if PR author is repository owner
        id: check_owner
        env:
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          REPO_OWNER: ${{ github.repository_owner }}
        run: |
          echo "PR Author: $PR_AUTHOR"
          echo "Repository Owner: $REPO_OWNER"
          
          if [ "$PR_AUTHOR" = "$REPO_OWNER" ]; then
            echo "is_owner=true" >> $GITHUB_OUTPUT
            echo "‚úÖ PR author is the repository owner"
          else
            echo "is_owner=false" >> $GITHUB_OUTPUT
            echo "‚ùå PR author is NOT the repository owner"
          fi

      - name: Auto-merge owner PR
        if: steps.check_owner.outputs.is_owner == 'true' && steps.check_template.outputs.template_filled == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            
            try {
              // Attempt to merge the PR
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                merge_method: 'squash',
                commit_title: `${pr.title} (#${pr.number})`,
                commit_message: pr.body || ''
              });
              
              console.log('‚úÖ PR auto-merged successfully');
              
              // Add success comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: '‚úÖ **Auto-merged**: PR automatically merged because you are the repository owner and all checks passed.'
              });
            } catch (error) {
              console.log('‚ö†Ô∏è Auto-merge failed:', error.message);
              
              // Add comment explaining the issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: `‚ö†Ô∏è **Auto-merge attempted but failed**: ${error.message}\n\nYou may need to merge manually or check branch protection settings.`
              });
            }

      - name: Request approval for non-owner PR
        if: steps.check_owner.outputs.is_owner == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: 'üëã **Manual Review Required**: This PR requires approval from the repository owner (@${{ github.repository_owner }}) before it can be merged.'
            });
            
            console.log('üìù Added comment requesting owner approval');

  # ============================================
  # Job 3: Deploy to Production (runs after merge to master)
  # ============================================
  deploy:
    needs: build
    if: (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.PRODUCTION_HOST }} >> ~/.ssh/known_hosts
          echo "‚úÖ Added server to known hosts"

      - name: Copy files to production server
        run: |
          echo "üì¶ Syncing files to production server..."
          rsync -avz --delete \
            --exclude 'logs/' \
            --exclude '.git/' \
            --exclude '.env' \
            --exclude 'node_modules/' \
            --exclude '.next/' \
            ./ ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }}:${{ secrets.PRODUCTION_PATH }}
          echo "‚úÖ Files synced successfully"

      - name: Deploy on production server
        run: |
          echo "üöÄ Starting deployment on production server..."
          ssh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} << 'ENDSSH'
            cd ${{ secrets.PRODUCTION_PATH }}
            
            # Use docker compose (newer) or docker-compose (older)
            if command -v docker &> /dev/null && docker compose version &> /dev/null; then
              echo "Using 'docker compose' (newer syntax)"
              docker compose pull
              docker compose down
              docker compose up -d --build
            elif command -v docker-compose &> /dev/null; then
              echo "Using 'docker-compose' (older syntax)"
              docker-compose pull
              docker-compose down
              docker-compose up -d --build
            else
              echo "‚ùå Error: Neither 'docker compose' nor 'docker-compose' found"
              exit 1
            fi
            
            echo "‚úÖ Deployment completed"
          ENDSSH

      - name: Verify deployment
        run: |
          echo "üîç Verifying deployment..."
          ssh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} \
            "cd ${{ secrets.PRODUCTION_PATH }} && (docker compose ps || docker-compose ps)"

      - name: Notify deployment success
        if: success()
        run: |
          echo "‚úÖ üéâ Deployment to production successful!"
          echo "Deployed commit: ${{ github.sha }}"
          echo "Deployed by: ${{ github.actor }}"

      - name: Notify deployment failure
        if: failure()
        run: |
          echo "‚ùå Deployment to production failed!"
          echo "Please check the logs above for details."
          exit 1
